<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JayDL - Download Videos & Music</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="oauth.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* YouTube specific styling */
        .youtube-notice {
            background: #ff000010;
            border-left: 4px solid #FF0000;
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 0 5px 5px 0;
        }
        
        .youtube-notice i {
            color: #FF0000;
            margin-right: 8px;
        }
        
        /* Platform badges */
        .platform-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            text-transform: uppercase;
        }
        
        .platform-badge.youtube {
            background: #FF0000;
            color: white;
        }
        
        .platform-badge.tiktok {
            background: #000000;
            color: white;
        }
        
        .platform-badge.instagram {
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            color: white;
        }
        
        .platform-badge.twitter {
            background: #1DA1F2;
            color: white;
        }
        
        .platform-badge.spotify {
            background: #1DB954;
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <div class="navbar-left">
                <button class="navbar-menu-btn" id="menuBtn" title="Menu">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="navbar-brand">
                    <h1><i class="fas fa-download"></i> JayDL</h1>
                </div>
            </div>
            <p class="navbar-subtitle">Download videos and music from various platforms</p>
            <div class="navbar-right">
                <button class="navbar-chat-btn" id="chatBtn" title="Open Chatbot">
                    <i class="fas fa-comments"></i>
                </button>
                <button class="navbar-chat-btn" id="adminBtn" title="Admin Panel">
                    <i class="fas fa-user-shield"></i>
                </button>
            </div>
        </div>
        
        <!-- Dropdown Menu -->
        <div class="navbar-dropdown hidden" id="navbarDropdown">
            <a href="#" class="dropdown-item" onclick="scrollToSection('platforms'); return false;">
                <i class="fas fa-globe"></i> Supported Platforms
            </a>
            <a href="#" class="dropdown-item" onclick="openChatbot(); return false;">
                <i class="fas fa-comments"></i> Chatbot Assistant
            </a>
            <a href="#" class="dropdown-item" onclick="showBrowserHelp(); return false;">
                <i class="fas fa-question-circle"></i> YouTube Help
            </a>
        </div>
    </nav>

    <div class="container">
        <main>
            <div class="card input-section">
                <div class="url-input-container">
                    <input type="text" id="urlInput" placeholder="Paste YouTube, TikTok, Instagram, Twitter, or Spotify URL here...">
                    <button id="pasteBtn" class="btn btn-icon" title="Paste from clipboard">
                        <i class="fas fa-paste"></i>
                    </button>
                    <button id="analyzeBtn" class="btn btn-primary">
                        <i class="fas fa-search"></i> Analyze
                    </button>
                </div>

                <div id="errorAlert" class="alert alert-error hidden"></div>
                <div id="successAlert" class="alert alert-success hidden"></div>

                <div class="media-type-section">
                    <h3>Download Type</h3>
                    <div class="options-grid">
                        <button class="option-btn active" data-type="video">
                            <i class="fas fa-video"></i> Video
                        </button>
                        <button class="option-btn" data-type="audio">
                            <i class="fas fa-music"></i> Audio Only
                        </button>
                    </div>
                </div>

                <div id="mediaInfo" class="media-info hidden">
                    <div class="media-preview">
                        <img id="mediaThumbnail" src="" alt="Thumbnail" class="thumbnail" crossorigin="anonymous">
                        <div class="media-details">
                            <h3 id="mediaTitle">Media Title</h3>
                            <div class="meta-info">
                                <span id="mediaDuration" style="display: none;"><i class="fas fa-clock"></i> <span id="durationValue">0:00</span></span>
                                <span id="mediaUploader" style="display: none;"><i class="fas fa-user"></i> <span id="uploaderValue">Unknown</span></span>
                                <span id="mediaPlatform" style="display: none;"><i class="fas fa-globe"></i> <span id="platformValue">Unknown</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="quality-section">
                        <h3>Quality Options</h3>
                        <div id="formatTabs" class="format-tabs" style="display: none;">
                            <button class="format-tab-btn active" data-format="all">All</button>
                            <button class="format-tab-btn" data-format="mp4">MP4</button>
                            <button class="format-tab-btn" data-format="webm">WebM</button>
                        </div>
                        <div id="qualityOptions" class="options-grid"></div>
                    </div>

                    <button id="downloadBtn" class="btn btn-download">
                        <i class="fas fa-download"></i> Download Now
                    </button>
                </div>
            </div>

            <div class="card platforms-section">
                <h3>Supported Platforms</h3>
                <div id="platformsGrid" class="platforms-grid"></div>
            </div>
        </main>
    </div>

    <div id="loadingModal" class="modal hidden">
        <div class="modal-content">
            <div class="loading-spinner"></div>
            <h3 id="loadingMessage">Processing...</h3>
            <p>Please wait while we process your request</p>
        </div>
    </div>

    <div id="chatbotModal" class="chatbot-modal hidden">
        <div class="chatbot-container">
            <div class="chatbot-header">
                <h2><i class="fas fa-comments"></i> JayDL Assistant</h2>
                <button class="chatbot-close-btn" onclick="closeChatbot()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="chatbot-maintenance">
                <div class="maintenance-icon">
                    <i class="fas fa-tools"></i>
                </div>
                <h3>Under Maintenance</h3>
                <p>The chatbot is currently undergoing maintenance and will be back online soon.</p>
                <p>Thank you for your patience!</p>
            </div>
        </div>
    </div>

    <!-- Admin Panel Modal -->
    <div id="adminPanelModal" class="modal hidden">
        <div class="modal-content" style="max-width: 400px;">
            <div class="chatbot-header"> <!-- Reusing style -->
                <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                <button class="chatbot-close-btn" onclick="closeAdminPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="padding: 20px; text-align: center;">
                <h4>Authentication</h4>
                <p>Use this to authenticate with Google for YouTube access if you are having issues.</p>
                <button class="btn btn-primary" style="margin-top: 15px;" id="adminAuthBtn" onclick="startGoogleOAuth()">
                    <i class="fab fa-google"></i> Authenticate with Google
                </button>
            </div>
        </div>
    </div>

    <!-- Browser Help Modal -->
    <div id="browserHelpModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <h2><i class="fab fa-youtube"></i> YouTube Download Help</h2>
            <div class="help-section">
                <h3><i class="fas fa-check-circle"></i> How it works:</h3>
                <p>JayDL uses your browser cookies to access YouTube. This means you need to be signed into YouTube in your browser.</p>
                
                <div class="help-steps">
                    <div class="help-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h4>Sign into YouTube</h4>
                            <p>Open <a href="https://youtube.com" target="_blank">YouTube.com</a> and make sure you're signed in with your Google account.</p>
                        </div>
                    </div>
                    
                    <div class="help-step">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h4>Don't clear cookies</h4>
                            <p>Don't clear your browser cookies before using JayDL. The app needs your YouTube session cookies.</p>
                        </div>
                    </div>
                    
                    <div class="help-step">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h4>Use the same browser</h4>
                            <p>Make sure you're using the same browser where you're signed into YouTube (Chrome, Firefox, Edge, etc.).</p>
                        </div>
                    </div>
                    
                    <div class="help-step">
                        <div class="step-number">4</div>
                        <div class="step-content">
                            <h4>Try private/age-restricted videos</h4>
                            <p>Being signed in also allows you to download private and age-restricted YouTube videos.</p>
                        </div>
                    </div>
                </div>
                
                <div class="help-tips">
                    <h3><i class="fas fa-lightbulb"></i> Tips for best results:</h3>
                    <ul>
                        <li>Use Chrome or Firefox for best compatibility</li>
                        <li>Keep your browser updated</li>
                        <li>Don't use incognito/private mode</li>
                        <li>If downloads fail, try signing out and back into YouTube</li>
                    </ul>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="closeBrowserHelp()">
                    <i class="fas fa-check"></i> Got it!
                </button>
                <button class="btn" onclick="window.open('https://youtube.com', '_blank')">
                    <i class="fab fa-youtube"></i> Open YouTube
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://jaydl-backend.onrender.com';
        let currentMediaInfo = null;
        let selectedQuality = 'best';
        let selectedMediaType = 'video';

        function formatFileSize(bytes) {
            if (!bytes || bytes === 'Unknown' || bytes === 0) return 'Unknown';
            const kb = 1024;
            const mb = kb * 1024;
            const gb = mb * 1024;
            
            if (bytes >= gb) return (bytes / gb).toFixed(2) + ' GB';
            if (bytes >= mb) return (bytes / mb).toFixed(2) + ' MB';
            if (bytes >= kb) return (bytes / kb).toFixed(2) + ' KB';
            return bytes + ' B';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPlatforms();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('pasteBtn').addEventListener('click', pasteFromClipboard);
            document.getElementById('analyzeBtn').addEventListener('click', analyzeMedia);
            document.getElementById('downloadBtn').addEventListener('click', downloadMedia);
            
            document.getElementById('urlInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') analyzeMedia();
            });

            document.querySelectorAll('.option-btn[data-type]').forEach(btn => {
                btn.addEventListener('click', () => selectMediaType(btn));
            });

            // Format tab listeners
            document.querySelectorAll('.format-tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.format-tab-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    const format = e.target.dataset.format;
                    filterFormatOptions(format);
                });
            });

            document.getElementById('adminBtn').addEventListener('click', () => {
                const password = prompt('Enter admin password:');
                if (password === 'smprime123') {
                    openAdminPanel();
                } else if (password !== null) { // if user didn't click cancel
                    alert('Incorrect password.');
                }
            });
        }

        function showBrowserHelp() {
            document.getElementById('browserHelpModal').classList.remove('hidden');
        }

        function closeBrowserHelp() {
            document.getElementById('browserHelpModal').classList.add('hidden');
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('urlInput').value = text;
                showSuccess('URL pasted from clipboard!');
            } catch (err) {
                showError('Failed to paste from clipboard');
            }
        }

        function selectMediaType(btn) {
            document.querySelectorAll('.option-btn[data-type]').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedMediaType = btn.dataset.type;
            
            // Reset format tabs when switching type
            document.querySelectorAll('.format-tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.format-tab-btn[data-format="all"]').classList.add('active');
            
            // Refresh quality options when switching type
            if (currentMediaInfo) {
                displayQualityOptions(currentMediaInfo);
            }
        }

        function filterFormatOptions(format) {
            const buttons = document.querySelectorAll('#qualityOptions .option-btn');
            buttons.forEach(btn => {
                const container = btn.dataset.container || 'unknown';
                if (format === 'all') {
                    btn.style.display = '';
                } else if (format === 'mp4' && (container === 'mp4' || btn.dataset.formatId === 'mp4')) {
                    btn.style.display = '';
                } else if (format === 'webm' && container === 'webm') {
                    btn.style.display = '';
                } else {
                    btn.style.display = 'none';
                }
            });
        }

        function displayQualityOptions(data) {
            const qualityOptions = document.getElementById('qualityOptions');
            const formatTabs = document.getElementById('formatTabs');
            qualityOptions.innerHTML = '';
            
            if (data.formats && data.formats.length > 0) {
                // Sort formats: videos first, then audio
                const sorted = data.formats.sort((a, b) => {
                    if (a.type === 'video' && b.type !== 'video') return -1;
                    if (a.type !== 'video' && b.type === 'video') return 1;
                    return 0;
                });

                // Check if we have both mp4 and webm formats (only for videos)
                const videoFormats = sorted.filter(f => f.type === 'video');
                const hasMP4 = videoFormats.some(f => f.container === 'mp4' || f.format_id === 'mp4');
                const hasWebM = videoFormats.some(f => f.container === 'webm');
                
                // Show format tabs ONLY when in video mode AND we have both formats
                if (selectedMediaType === 'video' && hasMP4 && hasWebM) {
                    formatTabs.style.display = 'flex';
                } else {
                    formatTabs.style.display = 'none';
                }

                sorted.forEach(format => {
                    // Skip audio formats when in video mode, skip video when in audio mode
                    if (selectedMediaType === 'video' && format.type === 'audio') {
                        return; // Skip audio when video is selected
                    }
                    if (selectedMediaType === 'audio' && format.type === 'video') {
                        return; // Skip video when audio is selected
                    }

                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.dataset.formatType = format.type;
                    btn.dataset.formatId = format.format_id;
                    btn.dataset.container = format.container || 'unknown';
                    
                    const resolution = format.resolution || format.format || 'Unknown';
                    const formatId = format.format_id || format.type || resolution.toLowerCase();
                    
                    let label = resolution;
                    
                    // Format and add file size if available with proper formatting
                    const filesize = formatFileSize(format.filesize);
                    if (filesize !== 'Unknown') {
                        label += `<br><small class="filesize-badge">ðŸ“¦ ${filesize}</small>`;
                    }
                    
                    // Add format type badge
                    if (format.type === 'audio') {
                        label += `<br><span class="quality-badge">AUDIO</span>`;
                    } else if (format.container) {
                        const containerUpper = format.container.toUpperCase();
                        label += `<br><span class="quality-badge">${containerUpper}</span>`;
                    }
                    
                    btn.innerHTML = label;
                    btn.onclick = () => selectQuality(btn, formatId, format.type);
                    qualityOptions.appendChild(btn);
                });

                // Auto-select first option
                const firstBtn = qualityOptions.firstChild;
                if (firstBtn) {
                    firstBtn.classList.add('active');
                    const firstFormat = data.formats.find(f => 
                        (selectedMediaType === 'audio' && f.type === 'audio') || 
                        (selectedMediaType === 'video' && f.type === 'video')
                    ) || data.formats[0];
                    selectedQuality = firstFormat.format_id || firstFormat.type || 'best';
                    console.log('Auto-selected quality:', selectedQuality);
                }
            }
        }

        async function analyzeMedia() {
            const url = document.getElementById('urlInput').value.trim();
            
            if (!url) {
                showError('Please enter a URL');
                return;
            }

            // Basic URL validation
            if (!isValidUrl(url)) {
                showError('Please enter a valid URL');
                return;
            }

            showLoading('Analyzing media...');
            hideError();
            hideSuccess();

            try {
                console.log('Analyzing URL:', url);
                console.log('Backend URL:', API_BASE);
                
                const response = await fetch(`${API_BASE}/api/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url }),
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    displayMediaInfo(data);
                    showSuccess('Media analyzed successfully!');
                } else {
                    const url = document.getElementById('urlInput').value.trim();
                    const isYouTubeUrl = url.includes('youtube.com') || url.includes('youtu.be');
                    let errorMsg = data.error || 'Failed to analyze media';

                    if (isYouTubeUrl && errorMsg.includes('Failed to extract any player response')) {
                        errorMsg += '<br><br><b>Suggestion:</b> This can happen with music or region-locked videos. Try authenticating via the <b>Admin Panel</b> to resolve this.';
                    }
                    showError(errorMsg);
                }
            } catch (err) {
                hideLoading();
                console.error('Analysis error:', err);
                showError(`Network error: ${err.message}. Make sure the backend is running on ${API_BASE}`);
            }
        }

        function displayMediaInfo(data) {
            currentMediaInfo = data;
            
            // Debug log
            console.log('Media info received:', data);
            
            // Set media information
            const thumbnailImg = document.getElementById('mediaThumbnail');
            let thumbnailUrl = data.thumbnail || '';
            
            // If no thumbnail, use platform-specific logo
            if (!thumbnailUrl) {
                if (data.platform === 'instagram') {
                    // Use Instagram logo as fallback
                    thumbnailUrl = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"%3E%3Cdefs%3E%3ClinearGradient id="insta-gradient" x1="0%" y1="100%" x2="100%" y2="0%"%3E%3Cstop offset="0%" style="stop-color:%23feda75;stop-opacity:1" /%3E%3Cstop offset="5%" style="stop-color:%23fa7e1e;stop-opacity:1" /%3E%3Cstop offset="45%" style="stop-color:%23d92e7f;stop-opacity:1" /%3E%3Cstop offset="60%" style="stop-color:%239b36b7;stop-opacity:1" /%3E%3Cstop offset="90%" style="stop-color:%23515bd4;stop-opacity:1" /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="200" height="200" fill="url(%23insta-gradient)"%3E%3C/rect%3E%3Crect x="40" y="40" width="120" height="120" rx="30" fill="none" stroke="white" stroke-width="8"%3E%3C/rect%3E%3Ccircle cx="100" cy="100" r="30" fill="none" stroke="white" stroke-width="8"%3E%3C/circle%3E%3Ccircle cx="145" cy="55" r="8" fill="white"%3E%3C/circle%3E%3C/svg%3E';
                } else if (data.platform === 'tiktok') {
                    // Use TikTok logo colors
                    thumbnailUrl = 'https://via.placeholder.com/200x150?text=TikTok&bg=000000&txtcolor=25F4EE';
                } else if (data.platform === 'twitter') {
                    // Use Twitter/X logo colors
                    thumbnailUrl = 'https://via.placeholder.com/200x150?text=Twitter&bg=000000&txtcolor=FFFFFF';
                } else if (data.platform === 'spotify') {
                    // Use Spotify logo colors
                    thumbnailUrl = 'https://via.placeholder.com/200x150?text=Spotify&bg=1DB954&txtcolor=FFFFFF';
                } else {
                    // Generic placeholder
                    thumbnailUrl = 'https://via.placeholder.com/200x150?text=No+Image';
                }
            }
            
            // Add error handler in case thumbnail fails to load
            thumbnailImg.onerror = function() {
                console.log('Thumbnail failed to load, showing platform logo');
                // Fallback to platform-specific fallback
                if (data.platform === 'instagram') {
                    this.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"%3E%3Cdefs%3E%3ClinearGradient id="insta-gradient" x1="0%" y1="100%" x2="100%" y2="0%"%3E%3Cstop offset="0%" style="stop-color:%23feda75;stop-opacity:1" /%3E%3Cstop offset="5%" style="stop-color:%23fa7e1e;stop-opacity:1" /%3E%3Cstop offset="45%" style="stop-color:%23d92e7f;stop-opacity:1" /%3E%3Cstop offset="60%" style="stop-color:%239b36b7;stop-opacity:1" /%3E%3Cstop offset="90%" style="stop-color:%23515bd4;stop-opacity:1" /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="200" height="200" fill="url(%23insta-gradient)"%3E%3C/rect%3E%3Crect x="40" y="40" width="120" height="120" rx="30" fill="none" stroke="white" stroke-width="8"%3E%3C/rect%3E%3Ccircle cx="100" cy="100" r="30" fill="none" stroke="white" stroke-width="8"%3E%3C/circle%3E%3Ccircle cx="145" cy="55" r="8" fill="white"%3E%3C/circle%3E%3C/svg%3E';
                } else {
                    this.src = 'https://via.placeholder.com/200x150?text=No+Image';
                }
            };
            
            thumbnailImg.src = thumbnailUrl;
            console.log('Setting thumbnail URL:', thumbnailUrl);
            
            document.getElementById('mediaTitle').textContent = data.title || 'Unknown Title';
            
            // Show/hide media type section - HIDE for Spotify
            const mediaTypeSection = document.querySelector('.media-type-section');
            const qualitySection = document.querySelector('.quality-section');
            if (data.platform === 'spotify') {
                mediaTypeSection.style.display = 'none';
                qualitySection.style.display = 'none';
                selectedMediaType = 'audio'; // Force audio for Spotify
            } else {
                mediaTypeSection.style.display = 'block';
                qualitySection.style.display = 'block';
            }
            
            // Show/hide duration if available
            const duration = data.duration || data.length;
            console.log('Duration value:', duration, 'Type:', typeof duration);
            if (duration && String(duration).trim() !== '' && String(duration) !== 'Unknown' && String(duration) !== 'N/A') {
                document.getElementById('durationValue').textContent = duration;
                document.getElementById('mediaDuration').style.display = 'flex';
                console.log('âœ“ Showing duration:', duration);
            } else {
                document.getElementById('mediaDuration').style.display = 'none';
                console.log('âœ— Hiding duration - value was:', duration);
            }
            
            // Show/hide uploader if available
            const uploader = data.uploader || data.upload_author || data.channel || data.creator;
            console.log('Uploader value:', uploader, 'Type:', typeof uploader);
            if (uploader && String(uploader).trim() !== '' && String(uploader) !== 'Unknown' && String(uploader) !== 'N/A') {
                document.getElementById('uploaderValue').textContent = uploader;
                document.getElementById('mediaUploader').style.display = 'flex';
                console.log('âœ“ Showing uploader:', uploader);
            } else {
                document.getElementById('mediaUploader').style.display = 'none';
                console.log('âœ— Hiding uploader - value was:', uploader);
            }
            
            // Show/hide platform if available
            if (data.platform && data.platform !== 'Unknown') {
                document.getElementById('platformValue').textContent = data.platform;
                document.getElementById('mediaPlatform').style.display = 'flex';
            } else {
                document.getElementById('mediaPlatform').style.display = 'none';
            }

            // Debug: log the formats
            console.log('Received formats:', data.formats);
            data.formats.forEach((fmt, idx) => {
                console.log(`Format ${idx}:`, fmt);
            });

            // Display quality options
            displayQualityOptions(data);

            document.getElementById('mediaInfo').classList.remove('hidden');
            document.getElementById('downloadBtn').disabled = false;
        }

        function selectQuality(btn, quality, formatType) {
            document.querySelectorAll('#qualityOptions .option-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            selectedQuality = quality;
            
            // Also update media type based on the quality selected
            if (formatType === 'audio') {
                selectedMediaType = 'audio';
            } else if (formatType === 'video') {
                selectedMediaType = 'video';
            }
            
            console.log('Selected quality:', quality, 'Format type:', formatType, 'Media type:', selectedMediaType);
        }

        async function downloadMedia() {
            if (!currentMediaInfo) {
                showError('Please analyze a URL first');
                return;
            }

            const url = document.getElementById('urlInput').value.trim();
            
            // Debug logging
            console.log('=== DOWNLOAD DEBUG ===');
            console.log('selectedQuality:', selectedQuality);
            console.log('selectedMediaType:', selectedMediaType);
            
            // Pass quality as-is (backend will interpret it)
            let quality = selectedQuality;
            console.log('Final quality to send:', quality);
            
            showLoading('Preparing download...');
            hideError();
            hideSuccess();

            try {
                const downloadPayload = {
                    url,
                    quality: quality,
                    media_type: selectedMediaType
                };
                console.log('Download payload:', downloadPayload);
                console.log('=== END DEBUG ===');
                
                const response = await fetch(`${API_BASE}/api/download`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(downloadPayload),
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                hideLoading();

                if (data.success) {
                    // Trigger download
                    if (data.download_url) {
                        let finalUrl = data.download_url;
                        // Handle both relative paths from our backend and absolute URLs from services like Invidious
                        if (finalUrl.startsWith('/')) {
                            finalUrl = `${API_BASE}${finalUrl}`;
                        }
                        window.location.href = finalUrl;
                        showSuccess('Download started! Check your downloads folder.');
                    } else if (data.filename) {
                        // Construct download URL if not provided
                        const downloadUrl = `${API_BASE}/api/file/${data.filename}`;
                        window.location.href = downloadUrl;
                        showSuccess('Download started! Check your downloads folder.');
                    } else {
                        showSuccess('Download prepared successfully!');
                    }
                    
                    // Show rate limit warning if applicable
                    if (data.remaining_downloads !== undefined && data.remaining_downloads !== null) {
                        const remaining = data.remaining_downloads;
                        if (remaining > 0 && remaining <= 5) {
                            showError(`âš ï¸ Spotify Rate Limit: Only ${remaining} downloads remaining today. Resets at midnight.`);
                        }
                    }
                } else {
                    // Check for rate limit error
                    if (data.rate_limit_hit) {
                        showError(`â›” Spotify Rate Limit Reached! You've reached 20 downloads today. This limit resets at midnight (${data.resets_at}). Please try again tomorrow.`);
                    } else if (data.need_browser_login) {
                        showError('âŒ ' + data.error);
                        showBrowserHelp();
                    } else {
                        showError(data.error || 'Download failed. Please try again.');
                        const url = document.getElementById('urlInput').value.trim();
                        const isYouTubeUrl = url.includes('youtube.com') || url.includes('youtu.be');
                        // Show browser help for YouTube errors
                        if (isYouTubeUrl && (data.error.includes('sign in') || data.error.includes('private') || data.error.includes('age restricted'))) {
                            showBrowserHelp();
                        }
                    }
                }
            } catch (err) {
                hideLoading();
                console.error('Download error:', err);
                showError(`Network error: ${err.message}`);
            }
        }

        async function loadPlatforms() {
            try {
                const response = await fetch(`${API_BASE}/api/platforms`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success && data.platforms) {
                    const grid = document.getElementById('platformsGrid');
                    grid.innerHTML = data.platforms.map(p => `
                        <div class="platform-card">
                            <i class="${p.icon}" style="color: ${p.color}"></i>
                            <div style="font-weight: 500; margin-top: 10px;">${p.name}</div>
                            ${p.supported ? '<small style="color: #10b981;">âœ“ Supported</small>' : '<small style="color: #ef4444;">âœ— Coming Soon</small>'}
                            ${p.hint ? `<br><small style="color: #8b5cf6; font-size: 11px;">${p.hint}</small>` : ''}
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Failed to load platforms:', err);
                // Show error message in platforms grid
                document.getElementById('platformsGrid').innerHTML = '<p style="color: #666;">Unable to load platforms. Make sure the backend is running.</p>';
            }
        }

        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingModal').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingModal').classList.add('hidden');
        }

        function showError(message) {
            const alert = document.getElementById('errorAlert');
            alert.innerHTML = message;
            alert.classList.remove('hidden');
            setTimeout(() => hideError(), 8000);
        }

        function hideError() {
            document.getElementById('errorAlert').classList.add('hidden');
        }

        function showSuccess(message) {
            const alert = document.getElementById('successAlert');
            alert.textContent = message;
            alert.classList.remove('hidden');
            setTimeout(() => hideSuccess(), 5000);
        }

        function hideSuccess() {
            document.getElementById('successAlert').classList.add('hidden');
        }

        // =============== NAVBAR & CHATBOT FUNCTIONS ===============

        // Navbar menu functionality
        document.getElementById('menuBtn').addEventListener('click', () => {
            const dropdown = document.getElementById('navbarDropdown');
            dropdown.classList.toggle('hidden');
        });

        // Chat button
        document.getElementById('chatBtn').addEventListener('click', openChatbot);

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('navbarDropdown');
            const menuBtn = document.getElementById('menuBtn');
            if (!e.target.closest('.navbar-menu-btn') && !e.target.closest('.navbar-dropdown')) {
                dropdown.classList.add('hidden');
            }
        });

        function scrollToSection(sectionId) {
            document.getElementById('navbarDropdown').classList.add('hidden');
            const section = document.querySelector('.platforms-section');
            if (section) {
                section.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function openChatbot() {
            document.getElementById('chatbotModal').classList.remove('hidden');
            document.getElementById('navbarDropdown').classList.add('hidden');
        }

        function closeChatbot() {
            document.getElementById('chatbotModal').classList.add('hidden');
        }

        function openAdminPanel() {
            document.getElementById('adminPanelModal').classList.remove('hidden');
        }

        function closeAdminPanel() {
            document.getElementById('adminPanelModal').classList.add('hidden');
        }

        // =============== COOKIE CONSENT ===============
        function showCookieConsent() {
            const consent = localStorage.getItem('cookieConsent');
            if (!consent) {
                document.getElementById('cookieConsent').style.display = 'block';
            }
        }

        function acceptCookies() {
            localStorage.setItem('cookieConsent', 'accepted');
            localStorage.setItem('cookieConsentDate', new Date().toISOString());
            document.getElementById('cookieConsent').style.display = 'none';
        }

        function rejectCookies() {
            localStorage.setItem('cookieConsent', 'rejected');
            document.getElementById('cookieConsent').style.display = 'none';
        }

        // Show cookie consent on page load if not already accepted/rejected
        window.addEventListener('load', showCookieConsent);
    </script>

    <!-- Cookie Consent Banner -->
    <div id="cookieConsent" class="cookie-consent" style="display: none;">
        <div class="cookie-content">
            <div class="cookie-message">
                <h3><i class="fas fa-cookie"></i> Cookie & Analytics Notice</h3>
                <p>We use cookies to remember your preferences and improve your experience. By clicking "Agree", you consent to our use of cookies for analytics and site functionality.</p>
                <p class="cookie-details">
                    <strong>Important:</strong> For YouTube downloads, JayDL uses your browser cookies to access YouTube. This requires you to be signed into YouTube in your browser.
                </p>
                <div class="cookie-links">
                    <a href="/privacy" target="_blank">Privacy Policy</a> â€¢ 
                    <a href="/terms" target="_blank">Terms of Service</a>
                </div>
            </div>
            <div class="cookie-buttons">
                <button class="cookie-btn-reject" onclick="rejectCookies()">Decline</button>
                <button class="cookie-btn-accept" onclick="acceptCookies()">Agree</button>
            </div>
        </div>
    </div>
</body>
</html>